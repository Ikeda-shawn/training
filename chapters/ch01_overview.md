# 第1章 CloudFormation の全体像と基本概念

## CloudFormation とは何か

AWS CloudFormation は、**AWS リソースを宣言的に定義し、自動的にプロビジョニングするサービス**です。

### 宣言的とは

「宣言的」とは、「どうやって作るか」ではなく「何を作りたいか」を記述する方式のことです。

#### 命令的な書き方（どうやって作るか）

```
1. VPC を作成する
2. その VPC ID を取得する
3. 取得した VPC ID を使って Subnet を作成する
4. その Subnet ID を取得する
5. 取得した Subnet ID を使って EC2 インスタンスを作成する
```

#### 宣言的な書き方（何を作りたいか）

```yaml
Resources:
  MyVPC:
    Type: AWS::EC2::VPC
    # VPC の定義

  MySubnet:
    Type: AWS::EC2::Subnet
    # Subnet の定義（MyVPC を参照）

  MyEC2:
    Type: AWS::EC2::Instance
    # EC2 の定義（MySubnet を参照）
```

CloudFormation は、この宣言的な定義を読み取り、**適切な順序で自動的にリソースを作成**します。

## CloudFormation の基本用語

CloudFormation を理解するために、最初に覚えるべき3つの用語があります。

### 1. テンプレート（Template）

**AWS リソースの設計図**のことです。

- YAML または JSON 形式で記述されます
- 「どんなリソースを、どんな設定で作成するか」を定義します
- テンプレート自体は単なるテキストファイルです

例：`my-vpc-template.yaml`

### 2. スタック（Stack）

**テンプレートから作成されたリソースの集合**のことです。

- テンプレートを元に、実際に AWS 上にリソースを作成すると「スタック」が作られます
- スタックは1つの管理単位として扱われます
- スタックを削除すると、そのスタックに含まれるすべてのリソースが削除されます

例：`my-vpc-stack`（実際に稼働している VPC や Subnet などの集合）

### 3. リソース（Resource）

**テンプレートで定義する個々の AWS リソース**のことです。

- VPC、Subnet、EC2、S3 バケットなど、AWS の各種サービスを指します
- テンプレートの `Resources` セクションに記述します

### テンプレート、スタック、リソースの関係

```
テンプレート（設計図）
    ↓ デプロイ
スタック（実体）
    ├─ VPC（リソース）
    ├─ Subnet（リソース）
    └─ EC2 Instance（リソース）
```

## CloudFormation の責務と限界

CloudFormation は万能ではありません。何を CloudFormation に任せるべきで、何を任せるべきでないかを理解することが重要です。

### CloudFormation が得意なこと

#### 1. AWS リソースの構築と管理

- VPC、Subnet、SecurityGroup などのネットワークリソース
- EC2、RDS、S3 などのコンピューティング・ストレージリソース
- IAM ロール、ポリシーなどの権限管理

#### 2. リソース間の依存関係の解決

- 「VPC を作ってから Subnet を作る」といった順序を自動的に判断
- リソース間の参照を自動的に解決

#### 3. インフラの再現性の確保

- 同じテンプレートを使えば、同じ環境を何度でも作成できる
- 開発環境、ステージング環境、本番環境を同じテンプレートから作成可能

#### 4. 変更の追跡と管理

- スタックの変更履歴を追跡できる
- 変更前に影響範囲を確認できる（ChangeSet 機能）

### CloudFormation が苦手なこと

#### 1. リソース作成後の初期化処理

CloudFormation はリソースを作成することはできますが、作成後の細かい初期化処理は苦手です。

**例：EC2 インスタンスを作成した後、特定のソフトウェアをインストールする**

- CloudFormation でも UserData を使って実現できますが、複雑な処理は難しい
- Ansible、Chef などの構成管理ツールとの併用が推奨されます

#### 2. 条件分岐やループを含む複雑なロジック

CloudFormation にも条件分岐やループの機能はありますが、プログラミング言語のような柔軟性はありません。

- 複雑なロジックは読みにくく、メンテナンスしづらい
- CDK（Cloud Development Kit）などのツールを使うことで解決できる場合があります

#### 3. AWS 外部のリソース管理

CloudFormation は AWS のリソースしか管理できません。

- オンプレミスのサーバー管理はできません
- GitHub、Datadog などの外部サービスの設定はできません

#### 4. 動的な判断を伴う処理

CloudFormation はあくまで「宣言的」な定義であり、実行時の状況に応じて動的に判断することはできません。

**例：既存のリソースがあれば再利用し、なければ新規作成する**

- このような動的な判断は CloudFormation の責務範囲外です
- カスタムリソースや Lambda を使うことで部分的に対応できます

## CloudFormation を使う際の基本的な考え方

### 1. インフラをコードとして扱う（Infrastructure as Code）

CloudFormation テンプレートは、インフラの「コード」です。

- Git などのバージョン管理システムで管理する
- コードレビューを行う
- CI/CD パイプラインに組み込む

### 2. 手動変更は避ける

CloudFormation で管理しているリソースは、**CloudFormation 経由でのみ変更する**ことが推奨されます。

- AWS コンソールから直接変更すると、テンプレートと実際のリソースに差分が生まれる
- この差分を「ドリフト」と呼びます（第7章で詳しく説明します）

### 3. テンプレートの可読性を重視する

テンプレートは「読まれるもの」です。

- 他の人が読んでも理解できるように書く
- コメントを適切に使う
- 論理 ID やパラメータ名はわかりやすくする

### 4. 適切な粒度でスタックを分割する

すべてのリソースを1つのスタックに詰め込むのではなく、適切に分割します。

- ネットワーク層（VPC、Subnet）
- アプリケーション層（EC2、RDS）
- 監視層（CloudWatch、SNS）

分割することで、変更の影響範囲を限定し、管理しやすくなります。

## CloudFormation の利点

### 1. 再現性

同じテンプレートを使えば、同じ環境を何度でも作成できます。

### 2. 変更管理

インフラの変更履歴を Git で管理できます。

### 3. ドキュメント性

テンプレート自体が「現在のインフラの状態」を示すドキュメントになります。

### 4. 削除の容易さ

スタックを削除するだけで、すべてのリソースを一括削除できます。

### 5. 変更の事前確認

ChangeSet 機能を使うことで、変更を適用する前に影響範囲を確認できます。

## 次の章へ

CloudFormation の全体像が理解できたら、[第2章 テンプレートの基本構造](ch02_template_structure.md) に進んでください。

実際にテンプレートがどのように構成されているかを学びます。
