# 第1章 CloudFormationの全体像と基本概念

## CloudFormationとは何か

AWS CloudFormationは、**AWSリソースを宣言的に定義し、自動的にプロビジョニングするサービス**です。

### 宣言的とは

「宣言的」とは、「どうやって作るか」ではなく「**何を作りたいか**」を記述する方式のことです。

#### 命令的な書き方（どうやって作るか）

```
1. VPCを作成する
2. そのVPC IDを取得する
3. 取得したVPC IDを使ってSubnetを作成する
4. そのSubnet IDを取得する
5. 取得したSubnet IDを使ってEC2　インスタンスを作成する
```

#### 宣言的な書き方（何を作りたいか）

```yaml
Resources:
  MyVPC:
    Type: AWS::EC2::VPC
    # VPC の定義

  MySubnet:
    Type: AWS::EC2::Subnet
    # Subnet の定義（MyVPC を参照）

  MyEC2:
    Type: AWS::EC2::Instance
    # EC2 の定義（MySubnet を参照）
```

CloudFormationは、この宣言的な定義を読み取り、**適切な順序で自動的にリソースを作成**します。

## CloudFormationの基本用語

CloudFormationを理解するために、最初に覚えるべき3つの用語があります。

### 1. テンプレート（Template）

簡単に説明すると**AWS リソースの設計図**のことです。

- YAMLまたはJSON形式で記述されます (本レポジトリでは全てYAML形式で記述します)
- 「どんなリソースを、どんな設定で作成するか」を定義します
- テンプレート自体は単なるテキストファイルですが、CloudFormation 独自の構文ルールと制約を持つ定義ファイルです。

例：`my-vpc-template.yaml`

### 2. スタック（Stack）

**テンプレートから作成されたリソースの集合**のことです。

- テンプレートを元に、実際にAWS上にリソースを作成すると「スタック」が作られます
- スタックは1つの管理単位として扱われます
- スタックを削除すると、そのスタックに含まれるすべてのリソースが削除されます (※リソースへの削除保護をつけている場合はこの限りではありません。)

例：`my-vpc-stack`（実際に稼働しているVPCやSubnetなどの集合）

### 3. リソース（Resource）

**テンプレートで定義する個々のAWSリソース**のことです。

- VPC、Subnet、EC2、S3 バケットなど、AWSの各種サービスを指します
- テンプレートの`Resources`セクションに記述します

### テンプレート、スタック、リソースの関係

```
テンプレート（設計図）
    ↓ デプロイ
スタック（実体）
    ├─ VPC（リソース）
    ├─ Subnet（リソース）
    └─ EC2 Instance（リソース）
```

## CloudFormationの責務と限界

CloudFormationは万能ではありません。何をCloudFormationに任せるべきで、何を任せるべきでないかを理解することが重要です。

### CloudFormationが得意なこと

#### 1. AWSリソースの構築と管理

- VPC、Subnet、SecurityGroupなどのネットワークリソース
- EC2、RDS、S3などのコンピューティング・ストレージリソース
- IAM ロール、ポリシーなどの権限管理

#### 2. リソース間の依存関係の解決

- 「VPCを作ってからSubnetを作る」といった順序を自動的に判断
- リソース間の参照を自動的に解決 (※全ての依存関係が自動的に解決されるわけではありません)

#### 3. インフラの再現性の確保

- 同じテンプレートを使えば、同じ環境を何度でも作成できる
- 開発環境、ステージング環境、本番環境を同じテンプレートから作成可能

#### 4. 変更の追跡と管理

- スタックの変更履歴を追跡できる
- 変更前に影響範囲を確認できる（ChangeSet機能）

### CloudFormationが苦手なこと

#### 1. リソース作成後の初期化処理

CloudFormationはリソースを作成することはできますが、作成後の細かい初期化処理は苦手です。

**例：EC2 インスタンスを作成した後、特定のソフトウェアをインストールする**

- CloudFormationでもUserDataを使って実現できますが、複雑な処理は難しい(※CloudFormationの本来の責務は「リソースの作成と状態管理」であり、OS内部の構成管理まで担わせるのは推奨されません。)
- Ansible、Chefなどの構成管理ツールとの併用が推奨されます

#### 2. 条件分岐やループを含む複雑なロジック

CloudFormationにも条件分岐やループの機能はありますが、プログラミング言語のような柔軟性はありません。

- 複雑なロジックは読みにくく、メンテナンスしづらい

## CloudFormationを使う際の基本的な考え方

### 1. インフラをコードとして扱う（Infrastructure as Code）

CloudFormationテンプレートは、インフラの「コード」です。

そのため通常のアプリケーションのコードと同じように以下のような開発フローを回すことを前提に考える必要があります。

- Gitなどのバージョン管理システムで管理する
- コードレビューを行う
- CI/CDパイプラインに組み込む

### 2. 手動変更は避ける

CloudFormationで管理しているリソースは、**CloudFormation経由でのみ変更する**ことが推奨されます。

- コンソールから直接変更すると、テンプレートと実際のリソースに差分が生まれる
- この差分を「ドリフト」と呼びます（第7章で詳しく説明しますが、全ての差分がドリフトとして出力されるわけではありません）

### 3. テンプレートの可読性を重視する

テンプレートは「読まれるもの」です。

そのため、下記のことを意識しておく必要があります。

- 他の人が読んでも理解できるように書く
- コメントを適切に使う
- 論理IDやパラメータ名はわかりやすくする

### 4. 適切な粒度でスタックを分割する

すべてのリソースを1つのスタックに詰め込むのではなく、適切に分割します。

- ネットワーク層（VPC、Subnet）
- アプリケーション層（EC2、RDS）
- 監視層（CloudWatch、SNS）

分割することで、変更の影響範囲を限定し、管理しやすくなります。

## CloudFormation の利点

### 1. AWSネイティブなサービスであること

CloudFormationはAWSが公式に提供している **AWSネイティブな Infrastructure as Code（IaC）サービス**です。

- AWSサービスの仕様と強く整合している
- 新しいAWSサービス・機能への対応が早い
- AWSサポートの対象として扱われる

そのため、AWS環境を構築・運用するうえで、最も基本となるIaC サービスです。

---

### 2. 再現性

同じテンプレートを使えば、同じ環境を何度でも作成できます。

- 開発環境、検証環境、本番環境を同じ定義から構築できる
- 環境差異によるトラブルを防ぎやすい

---

### 3. 変更の事前確認（ChangeSet）

ChangeSet 機能を使うことで、変更を適用する前に以下を確認できます。

- どのリソースが作成・更新・削除されるのか
- 破壊的変更（リソース削除・再作成）が含まれていないか

これにより、**意図しない変更を防いだうえで安全に更新**できます。

---

## 次の章へ

CloudFormation の全体像が理解できたら、[第2章 テンプレートの基本構造](ch02_template_structure.md) に進んでください。

実際にテンプレートがどのように構成されているかを学びます。
